<!doctype html>
<html lang="en" data-bs-theme="dark">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Proxmox Backup Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
      body { padding: 16px; background-color: #1c1f24; }
      pre { white-space: pre-wrap; word-break: break-word; }
      .stat-number { font-size: 1.1rem; font-weight: 600; }
      .card { background-color: #23272f; }
      .badge-soft { background-color: rgba(255,255,255,0.1); color: #f0f0f0; }
      .table-dark td, .table-dark th { vertical-align: middle; }
    </style>
  </head>
  <body>
    <div class="container-fluid">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <div>
          <h3 class="mb-0">Proxmox Backup Dashboard</h3>
          <small class="text-secondary">Updated: {{ now }}</small>
        </div>
        <div class="d-flex gap-2 align-items-center">
          <a class="btn btn-sm btn-outline-info" href="https://github.com/datalorians/Proxmox-B2-Helper" target="_blank" rel="noopener">Repo</a>
          <button id="themeToggle" class="btn btn-sm btn-outline-secondary">Toggle Theme</button>
          <div id="actionAlert" class="alert d-none py-2 px-3 mb-0" role="alert"></div>
        </div>
      </div>

      <div class="row g-3">
        <div class="col-12 col-lg-6">
          <div class="card shadow-sm h-100">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <div>
                  <h5 class="card-title mb-1">Config Backups</h5>
                  <small class="text-secondary">Local: {{ local_cfg.count }} ({{ local_cfg.size_h }}) · B2: {{ remote_cfg.count }} ({{ remote_cfg.size_h }}){% if remote_cfg.error %} · <span class="text-danger">B2 error: {{ remote_cfg.error }}</span>{% endif %}</small>
                </div>
                <span class="badge bg-warning text-dark">Configs</span>
              </div>
              <div class="d-flex align-items-center gap-2 mb-3">
                <button id="btnConfig" class="btn btn-sm btn-primary">Run Config Backup</button>
                <div id="spinnerConfig" class="spinner-border spinner-border-sm text-primary d-none" role="status"></div>
              </div>

              <div class="mb-3">
                <div class="d-flex justify-content-between align-items-center mb-1">
                  <h6 class="mb-0">Recent Runs (journal)</h6>
                  <span class="badge badge-soft">last {{ runs_cfg|length }} events</span>
                </div>
                <div class="table-responsive">
                  <table class="table table-sm table-dark table-striped align-middle mb-0">
                    <thead>
                      <tr><th>When</th><th>Status</th><th>Duration</th><th>Note</th></tr>
                    </thead>
                    <tbody>
                      {% if runs_cfg|length == 0 %}
                        <tr><td colspan="4" class="text-secondary">No recent runs</td></tr>
                      {% else %}
                        {% for r in runs_cfg %}
                          <tr>
                            <td>{{ r.time }}</td>
                            <td><span class="badge {% if r.status == 'ok' %}bg-success{% else %}bg-danger{% endif %}">{{ r.status }}</span></td>
                            <td>{{ r.duration }}</td>
                            <td>{{ r.note }}</td>
                          </tr>
                        {% endfor %}
                      {% endif %}
                    </tbody>
                  </table>
                </div>
              </div>

              <div class="mb-3">
                <div class="d-flex justify-content-between align-items-center mb-1">
                  <h6 class="mb-0">Recent Archives</h6>
                  <span class="badge badge-soft">latest {{ archives_cfg|length }}</span>
                </div>
                <div class="table-responsive">
                  <table class="table table-sm table-dark table-striped align-middle mb-0">
                    <thead><tr><th>Name</th><th>When</th><th>Size</th></tr></thead>
                    <tbody>
                      {% if archives_cfg|length == 0 %}
                        <tr><td colspan="3" class="text-secondary">No archives found</td></tr>
                      {% else %}
                        {% for a in archives_cfg %}
                          <tr>
                            <td class="text-break">{{ a.name }}</td>
                            <td>{{ a.time }}</td>
                            <td>{{ a.size_h }}</td>
                          </tr>
                        {% endfor %}
                      {% endif %}
                    </tbody>
                  </table>
                </div>
              </div>

              <div class="mb-3">
                <h6 class="mb-1">Timer</h6>
                <div class="table-responsive">
                  <table class="table table-sm table-dark align-middle mb-0">
                    <tbody>
                      <tr><th scope="row">Next</th><td>{{ timers_struct.configs.next }}</td></tr>
                      <tr><th scope="row">Last</th><td>{{ timers_struct.configs.last }}</td></tr>
                      <tr><th scope="row">Unit</th><td>{{ timers_struct.configs.unit }}</td></tr>
                    </tbody>
                  </table>
                </div>
              </div>

              <div class="accordion" id="logsConfigs">
                <div class="accordion-item">
                  <h2 class="accordion-header" id="headingCfgLog">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseCfgLog">
                      Recent Logs
                    </button>
                  </h2>
                  <div id="collapseCfgLog" class="accordion-collapse collapse" data-bs-parent="#logsConfigs">
                    <div class="accordion-body">
                      <pre class="mb-0">{{ logs.configs }}</pre>
                    </div>
                  </div>
                </div>
              </div>

            </div>
          </div>
        </div>

        <div class="col-12 col-lg-6">
          <div class="card shadow-sm h-100">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <div>
                  <h5 class="card-title mb-1">VM / CT Backups</h5>
                  <small class="text-secondary">Local: {{ local_vms.count }} ({{ local_vms.size_h }}) · B2: {{ remote_vms.count }} ({{ remote_vms.size_h }}){% if remote_vms.error %} · <span class="text-danger">B2 error: {{ remote_vms.error }}</span>{% endif %}</small>
                </div>
                <span class="badge bg-success">VMs</span>
              </div>
              <form id="vmForm" class="row g-2 align-items-center mb-3">
                <div class="col-auto flex-grow-1">
                  <input type="text" class="form-control form-control-sm" id="vmidInput" name="vmid" placeholder="VMID" required>
                </div>
                <div class="col-auto">
                  <button id="btnVm" type="submit" class="btn btn-sm btn-success">Run VM/CT Backup</button>
                </div>
                <div class="col-auto">
                  <div id="spinnerVm" class="spinner-border spinner-border-sm text-success d-none" role="status"></div>
                </div>
              </form>

              <div class="mb-3">
                <div class="d-flex justify-content-between align-items-center mb-1">
                  <h6 class="mb-0">Recent Runs (journal)</h6>
                  <span class="badge badge-soft">last {{ runs_vms|length }} events</span>
                </div>
                <div class="table-responsive">
                  <table class="table table-sm table-dark table-striped align-middle mb-0">
                    <thead>
                      <tr><th>When</th><th>Status</th><th>Duration</th><th>Note</th></tr>
                    </thead>
                    <tbody>
                      {% if runs_vms|length == 0 %}
                        <tr><td colspan="4" class="text-secondary">No recent runs</td></tr>
                      {% else %}
                        {% for r in runs_vms %}
                          <tr>
                            <td>{{ r.time }}</td>
                            <td><span class="badge {% if r.status == 'ok' %}bg-success{% else %}bg-danger{% endif %}">{{ r.status }}</span></td>
                            <td>{{ r.duration }}</td>
                            <td>{{ r.note }}</td>
                          </tr>
                        {% endfor %}
                      {% endif %}
                    </tbody>
                  </table>
                </div>
              </div>

              <div class="mb-3">
                <div class="d-flex justify-content-between align-items-center mb-1">
                  <h6 class="mb-0">Recent Archives</h6>
                  <span class="badge badge-soft">latest {{ archives_vms|length }}</span>
                </div>
                <div class="table-responsive">
                  <table class="table table-sm table-dark table-striped align-middle mb-0">
                    <thead><tr><th>Name</th><th>When</th><th>Size</th></tr></thead>
                    <tbody>
                      {% if archives_vms|length == 0 %}
                        <tr><td colspan="3" class="text-secondary">No archives found</td></tr>
                      {% else %}
                        {% for a in archives_vms %}
                          <tr>
                            <td class="text-break">{{ a.name }}</td>
                            <td>{{ a.time }}</td>
                            <td>{{ a.size_h }}</td>
                          </tr>
                        {% endfor %}
                      {% endif %}
                    </tbody>
                  </table>
                </div>
              </div>

              <div class="mb-3">
                <h6 class="mb-1">Timer</h6>
                <div class="table-responsive">
                  <table class="table table-sm table-dark align-middle mb-0">
                    <tbody>
                      <tr><th scope="row">Next</th><td>{{ timers_struct.vms.next }}</td></tr>
                      <tr><th scope="row">Last</th><td>{{ timers_struct.vms.last }}</td></tr>
                      <tr><th scope="row">Unit</th><td>{{ timers_struct.vms.unit }}</td></tr>
                    </tbody>
                  </table>
                </div>
              </div>

              <div class="accordion" id="logsVms">
                <div class="accordion-item">
                  <h2 class="accordion-header" id="headingVmLog">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseVmLog">
                      Recent Logs
                    </button>
                  </h2>
                  <div id="collapseVmLog" class="accordion-collapse collapse" data-bs-parent="#logsVms">
                    <div class="accordion-body">
                      <pre class="mb-0">{{ logs.vms }}</pre>
                    </div>
                  </div>
                </div>
              </div>

            </div>
          </div>
        </div>
      </div>

      <div class="row g-3 mt-3">
        <div class="col-12">
          <div class="card shadow-sm">
            <div class="card-body">
              <h6 class="card-title mb-2">Action Result</h6>
              <pre id="actionResult" class="mb-0 text-secondary" style="min-height: 48px;"></pre>
            </div>
          </div>
        </div>
      </div>

      <div class="row g-3 mt-3">
        <div class="col-12">
          <div class="card shadow-sm">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <h6 class="mb-0">VMs / CTs</h6>
                <small class="text-secondary">Backup (stop mode) directly</small>
              </div>
              <div class="table-responsive">
                <table class="table table-sm table-dark table-striped align-middle mb-0" id="vmListTable">
                  <thead><tr><th>ID</th><th>Name</th><th>Type</th><th>Status</th><th>Storage est</th><th class="text-end">Action</th></tr></thead>
                  <tbody></tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="row g-3 mt-3">
        <div class="col-12">
          <div class="card shadow-sm">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <h6 class="mb-0">Credentials</h6>
                <small class="text-secondary">Stored in backup.env (local only)</small>
              </div>
              <form id="credsForm" class="row g-2">
                <div class="col-md-6">
                  <label class="form-label form-label-sm">B2 Account ID</label>
                  <input type="text" class="form-control form-control-sm" id="b2AccountId" />
                </div>
                <div class="col-md-6">
                  <label class="form-label form-label-sm">B2 App Key (leave blank to keep)</label>
                  <input type="password" class="form-control form-control-sm" id="b2AppKey" placeholder="********" />
                </div>
                <div class="col-md-6">
                  <label class="form-label form-label-sm">Bucket</label>
                  <input type="text" class="form-control form-control-sm" id="b2Bucket" />
                </div>
                <div class="col-md-6">
                  <label class="form-label form-label-sm">Prefix</label>
                  <input type="text" class="form-control form-control-sm" id="b2Prefix" />
                </div>
                <div class="col-md-3">
                  <label class="form-label form-label-sm">Retention Count</label>
                  <input type="number" class="form-control form-control-sm" id="retentionCount" />
                </div>
                <div class="col-md-3">
                  <label class="form-label form-label-sm">Keep Local (0/1)</label>
                  <input type="number" class="form-control form-control-sm" id="keepLocal" />
                </div>
                <div class="col-12 d-flex gap-2">
                  <button type="button" id="credsSave" class="btn btn-sm btn-primary">Save</button>
                  <button type="button" id="credsRefresh" class="btn btn-sm btn-secondary">Refresh</button>
                  <div id="credsSpinner" class="spinner-border spinner-border-sm text-primary d-none" role="status"></div>
                </div>
              </form>
            </div>
          </div>
        </div>
      </div>

      <div class="row g-3 mt-3">
        <div class="col-12 col-xl-6">
          <div class="card shadow-sm h-100">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <h6 class="mb-0">B2 Objects</h6>
                <small class="text-secondary">Delete from bucket</small>
              </div>
              <div class="table-responsive">
                <table class="table table-sm table-dark table-striped align-middle mb-2" id="b2ConfigsTable">
                  <thead><tr><th>Configs (B2)</th><th>When</th><th>Size</th><th>Storage est</th><th>Egress est</th><th></th></tr></thead>
                  <tbody></tbody>
                </table>
                <div class="text-secondary small" id="configsTotals"></div>
              </div>
              <div class="table-responsive">
                <table class="table table-sm table-dark table-striped align-middle mb-0" id="b2VmsTable">
                  <thead><tr><th>VMs (B2)</th><th>When</th><th>Size</th><th>Storage est</th><th>Egress est</th><th></th></tr></thead>
                  <tbody></tbody>
                </table>
                <div class="text-secondary small" id="vmsTotals"></div>
              </div>
            </div>
          </div>
        </div>
        <div class="col-12 col-xl-6">
          <div class="card shadow-sm h-100">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <h6 class="mb-0">Local Files</h6>
                <small class="text-secondary">Delete to free space</small>
              </div>
              <div class="table-responsive">
                <table class="table table-sm table-dark table-striped align-middle mb-2" id="localConfigsTable">
                  <thead><tr><th>Configs (local)</th><th>When</th><th>Size</th><th>Storage est</th><th></th></tr></thead>
                  <tbody></tbody>
                </table>
                <div class="text-secondary small" id="local_configsTotals"></div>
              </div>
              <div class="table-responsive">
                <table class="table table-sm table-dark table-striped align-middle mb-0" id="localVmsTable">
                  <thead><tr><th>VMs (local)</th><th>When</th><th>Size</th><th>Storage est</th><th></th></tr></thead>
                  <tbody></tbody>
                </table>
                <div class="text-secondary small" id="local_vmsTotals"></div>
              </div>
              <div class="table-responsive mt-2">
                <table class="table table-sm table-dark table-striped align-middle mb-0" id="localVmsDumpTable">
                  <thead><tr><th>VMs (dump + thinner)</th><th>When</th><th>Size</th><th>Storage est</th><th></th></tr></thead>
                  <tbody></tbody>
                </table>
                <div class="text-secondary small" id="local_vms_dumpTotals"></div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      function showAlert(kind, msg) {
        const el = document.getElementById('actionAlert');
        el.className = 'alert alert-' + kind + ' py-2 px-3 mb-0';
        el.textContent = msg;
        el.classList.remove('d-none');
      }

      function setSpinner(id, on) {
        const el = document.getElementById(id);
        if (!el) return;
        if (on) el.classList.remove('d-none'); else el.classList.add('d-none');
      }

      function setResult(text) {
        document.getElementById('actionResult').textContent = text || '';
      }

      async function loadBackups() {
        try {
          const resp = await fetch('/api/backups');
          const data = await resp.json();
          updateTotals('configs', data.b2_configs);
          updateTotals('vms', data.b2_vms);
          fillTable('b2ConfigsTable', data.b2_configs.items || [], 'configs', true, false, false, true, true);
          fillTable('b2VmsTable', data.b2_vms.items || [], 'vms', true, false, false, true, true);
          updateTotals('local_configs', data.local_configs);
          updateTotals('local_vms', data.local_vms);
          updateTotals('local_vms_dump', data.local_vms_dump);
          fillTable('localConfigsTable', data.local_configs.items || data.local_configs || [], 'configs', false, false, true, false, true);
          fillTable('localVmsTable', data.local_vms.items || data.local_vms || [], 'vms', false, false, true, false, true);
          fillTable('localVmsDumpTable', data.local_vms_dump.items || data.local_vms_dump || [], 'vms', false, true, true, false, true);
        } catch (e) {
          console.error(e);
        }
      }

      async function loadVMs() {
        try {
          const resp = await fetch('/api/vms');
          const data = await resp.json();
          const items = data.items || [];
          const tb = document.querySelector('#vmListTable tbody');
          if (!tb) return;
          tb.innerHTML = '';
          if (items.length === 0) {
            tb.innerHTML = '<tr><td class="text-secondary">empty</td></tr>';
            return;
          }
          items.forEach((it) => {
            const tr = document.createElement('tr');
            const id = it.id || '';
            const name = it.name || '';
            const type = it.type || '';
            const status = it.status || '';
            const est = it.est_storage ? `$${it.est_storage.toFixed(4)}` : '';
            tr.innerHTML = `<td>${id}</td><td>${name}</td><td>${type}</td><td>${status}</td><td>${est}</td><td class="text-end"><button class="btn btn-sm btn-outline-primary backup-btn">Backup (stop)</button></td>`;
            const btn = tr.querySelector('.backup-btn');
            btn.addEventListener('click', () => backupVM(id));
            tb.appendChild(tr);
          });
        } catch (e) {
          console.error(e);
        }
      }

      async function loadCreds() {
        try {
          const resp = await fetch('/api/creds');
          const data = await resp.json();
          document.getElementById('b2AccountId').value = data.B2_ACCOUNT_ID || '';
          document.getElementById('b2AppKey').value = '';
          document.getElementById('b2Bucket').value = data.B2_BUCKET || '';
          document.getElementById('b2Prefix').value = data.B2_PREFIX || '';
          document.getElementById('retentionCount').value = data.RETENTION_COUNT || '';
          document.getElementById('keepLocal').value = data.KEEP_LOCAL || '0';
        } catch (e) {
          console.error(e);
        }
      }

      async function saveCreds() {
        setSpinner('credsSpinner', true);
        showAlert('info', 'Saving credentials...');
        setResult('');
        const payload = {
          B2_ACCOUNT_ID: document.getElementById('b2AccountId').value.trim(),
          B2_APP_KEY: document.getElementById('b2AppKey').value.trim(),
          B2_BUCKET: document.getElementById('b2Bucket').value.trim(),
          B2_PREFIX: document.getElementById('b2Prefix').value.trim(),
          RETENTION_COUNT: document.getElementById('retentionCount').value.trim(),
          KEEP_LOCAL: document.getElementById('keepLocal').value.trim(),
        };
        try {
          const resp = await fetch('/api/creds', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload),
          });
          const text = await resp.text();
          setResult(text);
          if (resp.ok) {
            showAlert('success', 'Saved credentials');
            loadCreds();
          } else {
            showAlert('danger', 'Save failed');
          }
        } catch (e) {
          showAlert('danger', 'Error: ' + e);
        } finally {
          setSpinner('credsSpinner', false);
          document.getElementById('b2AppKey').value = '';
        }
      }

      function fillTable(tableId, items, scope, isB2, showPath, allowUpload, allowRestore, showCost) {
        const tb = document.querySelector(`#${tableId} tbody`);
        if (!tb) return;
        tb.innerHTML = '';
        if (!items || items.length === 0) {
          tb.innerHTML = '<tr><td class="text-secondary">empty</td></tr>';
          return;
        }
        items.forEach((it) => {
          const tr = document.createElement('tr');
          const name = it.name || '';
          const time = it.time || '';
          const size = it.size_h || '';
          const path = it.path || '';
          const storage = showCost && it.est_storage ? `$${it.est_storage.toFixed(4)}` : '';
          const egress = showCost && it.est_egress ? `$${it.est_egress.toFixed(4)}` : '';
          let buttons = '';
          if (allowUpload) buttons += '<button class="btn btn-sm btn-outline-primary me-1 upload-btn">Upload</button>';
          if (allowRestore) buttons += '<button class="btn btn-sm btn-outline-success me-1 restore-btn">Restore</button>';
          if (isB2) buttons += '<button class="btn btn-sm btn-outline-danger delete-btn">Delete</button>';
          const costCells = showCost ? `<td>${storage}</td><td>${egress}</td>` : '';
          tr.innerHTML = `<td class="text-break">${name}${showPath && path ? '<div class="text-secondary small">' + path + '</div>' : ''}</td><td>${time}</td><td>${size}</td>${costCells}<td class="text-end">${buttons}</td>`;
          const uploadBtn = tr.querySelector('.upload-btn');
          if (uploadBtn) uploadBtn.addEventListener('click', () => uploadItem(scope, path || name));
          const restoreBtn = tr.querySelector('.restore-btn');
          if (restoreBtn) restoreBtn.addEventListener('click', () => restoreItem(scope, name));
          const deleteBtn = tr.querySelector('.delete-btn');
          if (deleteBtn) deleteBtn.addEventListener('click', () => deleteItem(isB2, scope, name));
          tb.appendChild(tr);
        });
      }

      function updateTotals(scope, data) {
        if (!data) return;
        const storage = data.total_storage ? `$${data.total_storage.toFixed(4)}` : '$0.0000';
        const egress = data.total_egress ? `$${data.total_egress.toFixed(4)}` : '$0.0000';
        const el = document.getElementById(scope + 'Totals');
        if (el) el.textContent = `Storage est: ${storage} • Egress est: ${egress}`;
      }

      async function deleteItem(isB2, scope, name) {
        if (!confirm(`Delete ${name}?`)) return;
        const url = isB2 ? '/api/delete/b2' : '/api/delete/local';
        const fd = new FormData();
        fd.append('scope', scope);
        fd.append('name', name);
        try {
          const resp = await fetch(url, { method: 'POST', body: fd });
          const text = await resp.text();
          setResult(text);
          if (resp.ok) {
            showAlert('success', 'Deleted');
            loadBackups();
          } else {
            showAlert('danger', 'Delete failed');
          }
        } catch (e) {
          showAlert('danger', 'Error: ' + e);
        }
      }

      async function uploadItem(scope, path) {
        if (!path) return;
        const fd = new FormData();
        fd.append('scope', scope);
        fd.append('path', path);
        showAlert('info', `Uploading ${path}...`);
        setResult('');
        try {
          const resp = await fetch('/api/upload', { method: 'POST', body: fd });
          const text = await resp.text();
          setResult(text);
          if (resp.ok) {
            showAlert('success', 'Upload complete');
            loadBackups();
          } else {
            showAlert('danger', 'Upload failed');
          }
        } catch (e) {
          showAlert('danger', 'Error: ' + e);
        }
      }

      async function restoreItem(scope, name) {
        if (!name) return;
        const fd = new FormData();
        fd.append('scope', scope);
        fd.append('name', name);
        showAlert('info', `Restoring ${name}...`);
        setResult('');
        try {
          const resp = await fetch('/api/restore', { method: 'POST', body: fd });
          const text = await resp.text();
          setResult(text);
          if (resp.ok) {
            showAlert('success', 'Restore complete');
            loadBackups();
          } else {
            showAlert('danger', 'Restore failed: ' + text);
          }
        } catch (e) {
          showAlert('danger', 'Error: ' + e);
        }
      }

      async function backupVM(vmid) {
        if (!vmid) return;
        const fd = new FormData();
        fd.append('vmid', vmid);
        showAlert('info', `Running backup for ${vmid} (stop mode)...`);
        setResult('');
        try {
          const resp = await fetch('/api/vzdump', { method: 'POST', body: fd });
          const text = await resp.text();
          setResult(text);
          if (resp.ok) {
            showAlert('success', 'Backup finished (stop mode)');
            loadBackups();
          } else {
            showAlert('danger', 'Backup failed: ' + text);
          }
        } catch (e) {
          showAlert('danger', 'Error: ' + e);
        }
      }

      function applyTheme(theme) {
        document.documentElement.setAttribute('data-bs-theme', theme);
        localStorage.setItem('backupTheme', theme);
      }

      function initTheme() {
        const saved = localStorage.getItem('backupTheme');
        applyTheme(saved || 'dark');
      }

      async function postAction(url, spinnerId, successMsg) {
        setSpinner(spinnerId, true);
        showAlert('info', 'Running...');
        setResult('');
        try {
          const resp = await fetch(url, { method: 'POST' });
          const text = await resp.text();
          setResult(text);
          if (resp.ok) {
            showAlert('success', successMsg || 'Done.');
          } else {
            showAlert('danger', 'Error: ' + resp.status);
          }
        } catch (e) {
          showAlert('danger', 'Error: ' + e);
        } finally {
          setSpinner(spinnerId, false);
        }
      }

      document.getElementById('btnConfig').addEventListener('click', (e) => {
        e.preventDefault();
        postAction('/trigger/configs', 'spinnerConfig', 'Config backup started/completed.');
      });

      document.getElementById('vmForm').addEventListener('submit', (e) => {
        e.preventDefault();
        const vmid = document.getElementById('vmidInput').value.trim();
        if (!vmid) return;
        const formData = new FormData();
        formData.append('vmid', vmid);
        setSpinner('spinnerVm', true);
        showAlert('info', 'Running VM/CT backup...');
        setResult('');
        fetch('/trigger/vm', { method: 'POST', body: formData })
          .then(resp => resp.text().then(text => ({ ok: resp.ok, text, status: resp.status })))
          .then(({ ok, text, status }) => {
            setResult(text);
            if (ok) showAlert('success', 'VM/CT backup started/completed.');
            else showAlert('danger', 'Error: ' + status);
          })
          .catch(err => showAlert('danger', 'Error: ' + err))
          .finally(() => setSpinner('spinnerVm', false));
      });

      document.getElementById('themeToggle').addEventListener('click', () => {
        const current = document.documentElement.getAttribute('data-bs-theme') || 'dark';
        applyTheme(current === 'dark' ? 'light' : 'dark');
      });

      document.getElementById('credsSave').addEventListener('click', saveCreds);
      document.getElementById('credsRefresh').addEventListener('click', loadCreds);

      initTheme();
      loadBackups();
      loadVMs();
      loadCreds();
    </script>
  </body>
</html>
